<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMAN SPFILE リストア・シミュレーター2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        body { font-family: 'Fira Code', monospace; }
        .terminal-scroll::-webkit-scrollbar { width: 8px; }
        .terminal-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .terminal-scroll::-webkit-scrollbar-thumb:hover { background: #444; }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 min-h-screen p-4 md:p-8 flex flex-col items-center">

    <div class="max-w-4xl w-full">
        <!-- Header -->
        <header class="mb-6 text-center">
            <h1 class="text-2xl font-bold text-emerald-500 mb-2">RMAN SPFILE Restore Challenge</h1>
            <p class="text-gray-400 text-sm">SPFILEが消失したサーバーを復旧せよ。今回はバックアップ場所が特殊なようです...</p>
        </header>

        <!-- Main Game Area -->
        <div class="bg-gray-900 rounded-lg border border-gray-800 shadow-2xl overflow-hidden flex flex-col h-[600px]">
            
            <!-- Terminal Output -->
            <div id="terminal" class="flex-grow p-4 overflow-y-auto terminal-scroll text-sm leading-relaxed">
                <div class="text-blue-400 font-bold">[SYSTEM] サーバー障害発生：SPFILEが完全に破損しました。</div>
                <div class="text-gray-500">バックアップは /u01/app/oracle/backup/ に保存されているという報告があります。</div>
                <div class="text-gray-500">まずはRMANを起動してください。</div>
                <div class="border-b border-gray-800 my-2"></div>
            </div>

            <!-- Suggestion Box -->
            <div id="suggestion-container" class="bg-gray-800 px-4 py-2 hidden">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 font-bold text-emerald-500">Available Commands</div>
                <div id="suggestions" class="flex flex-wrap gap-2">
                    <!-- Suggestions appear here -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-black p-4 flex items-center gap-3 border-t border-gray-800">
                <span id="prompt-label" class="text-emerald-500 font-bold whitespace-nowrap">$</span>
                <input type="text" id="command-input" 
                       class="bg-transparent border-none outline-none w-full text-emerald-400 placeholder-gray-700"
                       placeholder="コマンドを入力するかサジェストを選択..."
                       autocomplete="off">
            </div>
        </div>

        <!-- Status Panel -->
        <div class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="bg-gray-900 p-3 rounded border border-gray-800">
                <div class="text-[10px] text-gray-500 uppercase">State</div>
                <div id="status-state" class="text-sm font-bold">OS</div>
            </div>
            <div class="bg-gray-900 p-3 rounded border border-gray-800">
                <div class="text-[10px] text-gray-500 uppercase">DBID</div>
                <div id="status-dbid" class="text-sm font-bold text-red-500">Not Set</div>
            </div>
            <div class="bg-gray-900 p-3 rounded border border-gray-800">
                <div class="text-[10px] text-gray-500 uppercase">Instance</div>
                <div id="status-instance" class="text-sm font-bold text-red-500">Down</div>
            </div>
            <div class="bg-gray-900 p-3 rounded border border-gray-800">
                <div class="text-[10px] text-gray-500 uppercase">Backup Location</div>
                <div id="status-format" class="text-sm font-bold text-yellow-500 font-mono text-[10px]">DEFAULT</div>
            </div>
            <div class="bg-gray-900 p-3 rounded border border-gray-800">
                <div class="text-[10px] text-gray-500 uppercase">SPFILE</div>
                <div id="status-spfile" class="text-sm font-bold text-red-500">Missing</div>
            </div>
        </div>
    </div>

    <script>
        const terminal = document.getElementById('terminal');
        const input = document.getElementById('command-input');
        const promptLabel = document.getElementById('prompt-label');
        const suggestionContainer = document.getElementById('suggestion-container');
        const suggestionList = document.getElementById('suggestions');

        // Game State
        let state = 'OS'; 
        let dbidSet = false;
        let isNomount = false;
        let formatSet = false;
        let isRestored = false;

        const commands = [
            { cmd: 'rman target /', context: 'OS', desc: 'RMANを起動' },
            { cmd: 'SET DBID 15263748', context: 'RMAN', desc: 'DBIDを15263748に設定' },
            { cmd: 'STARTUP NOMOUNT', context: 'RMAN', desc: 'ダミーパラメータでインスタンスを起動' },
            { cmd: "SET CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '/u01/app/oracle/backup/%F';", context: 'RMAN', desc: 'バックアップの場所を明示的に指定' },
            { cmd: 'RESTORE SPFILE FROM AUTOBACKUP', context: 'RMAN', desc: 'オートバックアップから復元実行' },
            { cmd: 'EXIT', context: 'RMAN', desc: '終了' }
        ];

        function log(msg, type = 'normal') {
            const div = document.createElement('div');
            if (type === 'error') div.className = 'text-red-400 mt-1';
            else if (type === 'success') div.className = 'text-emerald-400 mt-1 font-bold';
            else if (type === 'system') div.className = 'text-blue-400 mt-1 italic';
            else if (type === 'command') div.className = 'text-gray-500 mt-2';
            else div.className = 'text-gray-300 mt-1';
            
            div.innerHTML = msg.replace(/\n/g, '<br>');
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function updateStatus() {
            document.getElementById('status-state').textContent = state;
            document.getElementById('status-dbid').textContent = dbidSet ? '15263748' : 'Not Set';
            document.getElementById('status-dbid').className = dbidSet ? 'text-sm font-bold text-emerald-500' : 'text-sm font-bold text-red-500';
            
            document.getElementById('status-instance').textContent = isNomount ? 'NOMOUNT' : 'Down';
            document.getElementById('status-instance').className = isNomount ? 'text-sm font-bold text-emerald-500' : 'text-sm font-bold text-red-500';
            
            document.getElementById('status-format').textContent = formatSet ? '/u01/.../%F' : 'DEFAULT';
            document.getElementById('status-format').className = formatSet ? 'text-[10px] font-bold text-emerald-500 font-mono' : 'text-sm font-bold text-yellow-500 font-mono';

            document.getElementById('status-spfile').textContent = isRestored ? 'Restored' : 'Missing';
            document.getElementById('status-spfile').className = isRestored ? 'text-sm font-bold text-emerald-500' : 'text-sm font-bold text-red-500';
        }

        function showSuggestions() {
            const val = input.value;
            const filtered = commands.filter(c => c.context === state && c.cmd.toLowerCase().includes(val.toLowerCase()));
            
            if (filtered.length > 0) {
                suggestionContainer.classList.remove('hidden');
                suggestionList.innerHTML = '';
                filtered.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'text-left bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-xs transition-colors border border-gray-600 max-w-[250px]';
                    btn.innerHTML = `<span class="text-emerald-400 font-bold block truncate">${c.cmd}</span><span class="text-[9px] text-gray-400">${c.desc}</span>`;
                    btn.onclick = () => {
                        input.value = c.cmd;
                        executeCommand(c.cmd);
                    };
                    suggestionList.appendChild(btn);
                });
            } else {
                suggestionContainer.classList.add('hidden');
            }
        }

        function executeCommand(cmdText) {
            const cmd = cmdText.trim();
            const upperCmd = cmd.toUpperCase();
            log(`${promptLabel.textContent} ${cmd}`, 'command');
            input.value = '';
            suggestionContainer.classList.add('hidden');

            if (state === 'OS') {
                if (upperCmd === 'RMAN TARGET /') {
                    state = 'RMAN';
                    promptLabel.textContent = 'RMAN>';
                    log('Recovery Manager: Release 19.0.0.0.0 - Production\nconnected to target database (not started)', 'system');
                } else {
                    log('エラー: コマンドが見つかりません。', 'error');
                }
            } else if (state === 'RMAN') {
                if (upperCmd.startsWith('SET DBID')) {
                    dbidSet = true;
                    log('executing command: SET DBID\ndatabase identifier set to 15263748', 'system');
                } else if (upperCmd === 'STARTUP NOMOUNT') {
                    isNomount = true;
                    log('Oracle instance started with dummy parameter file', 'system');
                } else if (upperCmd.includes('SET CONTROLFILE AUTOBACKUP FORMAT')) {
                    formatSet = true;
                    log('executing command: SET CONTROLFILE AUTOBACKUP FORMAT', 'system');
                    log('オートバックアップの検索パスが更新されました。', 'success');
                } else if (upperCmd === 'RESTORE SPFILE FROM AUTOBACKUP') {
                    if (!dbidSet) {
                        log('RMAN-06497: DBID must be set to use restore spfile from autobackup', 'error');
                    } else if (!isNomount) {
                        log('ORA-01034: ORACLE not available', 'error');
                    } else if (!formatSet) {
                        log('Starting restore at 2023/05/22\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=123 device type=DISK', 'system');
                        log('RMAN-06172: no autobackup found or specified handle is not a valid copy or piece', 'error');
                        log('[トラブルシューティング情報]\n標準の場所（FRA）にバックアップが見つかりません。バックアップファイルが "/u01/app/oracle/backup/" にある場合、FORMATを指定する必要があります。', 'system');
                    } else {
                        isRestored = true;
                        log('Starting restore at 2023/05/22\nchannel ORA_DISK_1: looking for AUTOBACKUP on day: 20230522\nchannel ORA_DISK_1: AUTOBACKUP found: /u01/app/oracle/backup/c-15263748-20230522-01\nchannel ORA_DISK_1: restoring spfile from AUTOBACKUP\nFinished restore at 2023/05/22', 'success');
                        log('\nミッション成功！SPFILEが正常にリストアされました！', 'success');
                    }
                } else if (upperCmd === 'EXIT') {
                    state = 'OS';
                    promptLabel.textContent = '$';
                    log('Recovery Manager complete.', 'system');
                } else {
                    log('RMAN-00558: error encountered while parsing command', 'error');
                }
            }
            updateStatus();
        }

        input.oninput = showSuggestions;
        input.onfocus = showSuggestions;
        input.onkeydown = (e) => { if (e.key === 'Enter') executeCommand(input.value); };
        updateStatus();
    </script>
</body>
</html>
